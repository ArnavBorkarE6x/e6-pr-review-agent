# ============================================================================
# e6data PR Review Agent — Drop this file into any repo's .github/workflows/
# ============================================================================
#
# Prerequisites:
#   1. Add your AI API key as a repository secret:
#      - ANTHROPIC_API_KEY  (if using Claude — default)
#      - OPENAI_API_KEY     (if using OpenAI)
#
#   2. Ensure the default GITHUB_TOKEN has "pull-requests: write" permission
#      (it does by default for most repos)
#
# That's it. The agent will review every new/updated PR automatically.
# ============================================================================

name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

# Only one review at a time per PR (cancel in-flight if new push arrives)
concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # Don't run on the agent's own PRs or forks
    if: >-
      github.event.pull_request.user.login != 'github-actions[bot]' &&
      github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - name: Checkout review agent
        uses: actions/checkout@v4
        with:
          repository: ArnavBorkarE6x/e6-pr-review-agent
          path: .review-agent

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -q httpx pydantic anthropic openai tiktoken

      - name: Run AI review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          INPUT_AI_PROVIDER: "anthropic"
          INPUT_MODEL_PRIMARY: "claude-sonnet-4-5-20250929"
          INPUT_MODEL_LIGHTWEIGHT: "claude-haiku-4-5-20251001"
          INPUT_MAX_FILES: "50"
          INPUT_SKIP_DRAFTS: "true"
        run: python -m agent.main
        working-directory: .review-agent
